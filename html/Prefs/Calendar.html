<%args>
$ChangePrivateURL => undef
$ResetPrivateURL  => undef
</%args>

<& /Elements/Header, Title => $title &>
<& /Prefs/Elements/Tabs,
    current_tab => 'Prefs/Calendar.html',
    Title => $title
&>

<&| /Widgets/TitleBox, title => loc('ICal Private Feed Configuration ') , title_class=> 'inverse', color => "#993333" &>

% if ($PrivateURL) {
<p>Your can paste this url in your calendar  : <b><%$RT::WebURL%>/NoAuth/Calendar/<%$session{CurrentUser}->Id%>/<%$PrivateURL%></b><p>
<table>
<tr>
<td>
<form action="<%$RT::WebPath%>/Prefs/Calendar.html" method="post">
<input type="submit" class="button" name="ResetPrivateURL" value="<%loc('Disable ICal')%>">
</form>
</td>
<td>
<form action="<%$RT::WebPath%>/Prefs/Calendar.html" method="post">
<input type="submit" class="button" name="ChangePrivateURL" value="<%loc('Change ICal URL')%>">
</form>
</td>
</tr>
</table>
% } else {
<p>Your ICal feed is disabled.</p>

<form action="<%$RT::WebPath%>/Prefs/Calendar.html" method="post">
<input type="submit" class="button" name="ChangePrivateURL" value="<%loc('Enable ICal')%>">
</form>
% }
</&>

<%INIT>
my $title = loc("Calendar");

use Digest::SHA1;

if (defined $ChangePrivateURL) {
  $session{CurrentUser}->UserObj->AddCustomFieldValue(Field => 'IcalUrl', Value => Digest::SHA1::sha1_base64(time));
} elsif (defined $ResetPrivateURL) {
  $session{CurrentUser}->UserObj->AddCustomFieldValue(Field => 'IcalUrl', Value => '');
}

my $PrivateURL = $session{CurrentUser}->UserObj->FirstCustomFieldValue('IcalUrl');
</%INIT>
