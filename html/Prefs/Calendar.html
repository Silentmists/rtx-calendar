<%args>
$ChangeURL   => undef
$ResetURL    => undef
$SearchType  => 'Ticket'
$HiddenField => undef
</%args>

<& /Elements/Header, Title => $title &>
<& /User/Elements/Tabs,
    current_tab => 'Prefs/Calendar.html',
    Title => $title
&>

<& /Prefs/Elements/EditURL &>

% # only allow this part if
% if ($AllowSearch) {

%   # FIXME : _PrivacyObjects is a private method. Another way to find searches ?
%   my @Objects = RT::SavedSearches->new($session{CurrentUser})->_PrivacyObjects;
%   for my $object (@Objects) {
%     next unless ref($object) eq 'RT::User' && $object->id == $session{'CurrentUser'}->Id;
%     my @searches = $object->Attributes->Named('SavedSearch');
%     for my $search (@searches) {
%       next if ($search->SubValue('SearchType')
%              && $search->SubValue('SearchType') ne $SearchType);

<& /Prefs/Elements/EditURL, Object => $object, Search => $search &>

%     }
%   }
% } else {
%#<&| /Widgets/TitleBox, title => loc('Private Search ICal feeds')
%#                     , title_class=> 'inverse'
%#                     , color => "#993333" &>
%#
%#<%loc('Private search ICal feeds disabled. To enable them, ask your admin for "[_1]" and "[_2]" rights',
%#       loc('CreateSavedSearch'),
%#       loc('LoadSavedSearch') )%>
%#
%#</&>
% }

<%INIT>
use Digest::SHA1;
use RT::SavedSearches;

my $title = loc("Calendar Prefs");
my $AllowSearch;

$AllowSearch = 1
 if $session{'CurrentUser'}->HasRight( Right => 'LoadSavedSearch',
                                       Object=> $RT::System );

my $object;

if ($HiddenField eq 'Private') {
   $object = $session{CurrentUser};
} elsif ($AllowSearch and my ($SearchId) = $HiddenField =~ m/SavedSearch\-(\d+)/) {
    $object = $session{CurrentUser}->Attributes->WithId($SearchId);
}

if (defined $ChangeURL) {
  my @args = $object->SetAttribute(Name => 'ICalURL', Content => Digest::SHA1::sha1_base64(time));
} elsif (defined $ResetURL) {
  $object->DeleteAttribute('ICalURL');
}


</%INIT>
