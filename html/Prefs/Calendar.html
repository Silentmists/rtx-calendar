<%args>
$ChangeURL => undef
$ResetURL  => undef
</%args>

<& /Elements/Header, Title => $title &>
<& /Prefs/Elements/Tabs,
    current_tab => 'Prefs/Calendar.html',
    Title => $title
&>

<&| /Widgets/TitleBox, title => loc('ICal Calendar Configuration ') , title_class=> 'inverse', color => "#993333" &>

% if ($HiddenURL) {
<p>Your can paste this url in your calendar  : <b><%$RT::WebURL%>/NoAuth/Ical.ics?Id=<%$session{CurrentUser}->Id%>Hidden=<%$HiddenURL%></b><p>
<table>
<tr>
<td>
<form action="<%$RT::WebPath%>/Prefs/Calendar.html" method="post">
<input type="submit" class="button" name="ResetURL" value="<%loc('Disable ICal')%>">
</form>
</td>
<td>
<form action="<%$RT::WebPath%>/Prefs/Calendar.html" method="post">
<input type="submit" class="button" name="ChangeURL" value="<%loc('Change ICal URL')%>">
</form>
</td>
</tr>
</table>
% } else {
<p>Your ICal feed is disabled. To enable it, Change the hidden URL.</p>

<form action="<%$RT::WebPath%>/Prefs/Calendar.html" method="post">
<input type="submit" class="button" name="ChangeURL" value="<%loc('Enable ICal')%>">
</form>
% }

</&>


<%INIT>
my $title = loc("Calendar");

use Digest::SHA1;

if (defined $ChangeURL) {
  printf STDERR "%s message: %s\n", $session{CurrentUser}->UserObj->AddCustomFieldValue(Field => 'IcalUrl', Value => Digest::SHA1::sha1_base64(time));
} elsif (defined $ResetURL) {
  $session{CurrentUser}->UserObj->AddCustomFieldValue(Field => 'IcalUrl', Value => '');
}

my $HiddenURL = $session{CurrentUser}->UserObj->FirstCustomFieldValue('IcalUrl');
</%INIT>
